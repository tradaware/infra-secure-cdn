name: Build and Publish Docker Images
permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - development
  release:
    types: [published, prereleased]

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}

jobs:
  build-prod:
    env:
      REF_NAME: ${{ github.ref_name || 'local' }}
      IS_PRERELEASE: ${{ github.event.release.prerelease || false }}
    name: Build images
    runs-on: ubuntu-latest
      
    steps:
    - uses: actions/checkout@v4
    
    - name: Login to GitHub Container Registry
      run: echo ${{ secrets.GITHUB_TOKEN }} | docker login ghcr.io -u ${{ github.actor }} --password-stdin

    - name: Build and Push image
      run: |
        TAG=${{ env.REF_NAME }}${{ env.IS_PRERELEASE == 'true' && '-pre' || '' }}
        if [ "${{ github.ref_name }}" = "development" ]; then
          TAG="${{ github.sha }}-development"
        fi
        
        docker build . -t ghcr.io/tradaware/secure-cdn:$TAG
        docker push ghcr.io/tradaware/secure-cdn:$TAG
        
        if [ "${{ github.event_name }}" = "release" ] && [ "${{ env.IS_PRERELEASE }}" = "false" ]; then
          docker tag ghcr.io/tradaware/secure-cdn:$TAG ghcr.io/tradaware/secure-cdn:latest
          docker push ghcr.io/tradaware/secure-cdn:latest
        fi
